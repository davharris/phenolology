---
title: "Predicting pollination phenology in lodgepole pine"
author: "Susannah Tysor"
date: May 8, 2019
output:
  html_document: 
    toc: TRUE
  pdf_document:
    fig_caption: yes

---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
```

```{r depends, echo=FALSE, warning=FALSE}
library(dplyr)
library(rstan)
library(rethinking)
library(bayesplot)
library(stringr)
```
# Introduction
As the climate changes, spring phenological events like budburst and flowering will advance, especially for plants active in rapid seasonal transitions and short growing seasons [@Pau2011], like many high elevation and latitude conifers. 
This effect is already obvious in many species [@Parmesan2006; @Franks2014]. 
Changes in pollination phenology can affect fecundity, gene flow, and even range size in a species and have effects [VAGUE] on dependent species [@Inouye2008; @Chuine2001a].

[POLISH THIS INTRO SENTENCE]
Conifers are a big part of the enormous northern hemisphere forests and they have wide ranges with lots of local adaptation. Common garden experiments and genetic work reveal extensive local adaptation in many forest tree species, especially boreal and temperate conifers (reviewed in @Alberto2013a). A locally adapted population only grows optimally in a subset of the range and may tolerate a more limited climatic range than the species as a whole. In northern hemisphere conifers, local adaptation often reflects strong trade-offs between avoidance of cold damage and competitive height growth (summarized in @Aitken2008a). 

Coniferous forest trees are wind pollinated wtih pollination possible over large distances. [EXAMPLES]
Pollen is shed from male strobili and must arrive at receptive female strobili for successful pollination .rpe
Shifts in the timing of pollen shed and cone receptivity (pollination phenology) in conifers could lead to gene flow changes that hinder or promote adaptation under climate change, decrease fitness, and even affect reforestation via seed production declines. 
[Also affects gene flow now and is important for understanding current spatial genetic structure and local adaptation] 



Lodgepole pine is a good representative of these issues - an economically and ecologically important tree species facing multiple threats from climate change [@Schneider2010; @Sambaraju2012; @Hamann2006]. 
Lodgepole pine has a very large geographical distribution (across 33$^\circ$ latitude and 31$^\circ$ longitude) encompassing a wide range of climates and soils (Figure \ref{range}) with widespread and significant local adaptation in many traits. 
For example, populations from both northern interior British Columbia and northern Idaho can survive in areas with mean annual temperatures between -4 and 6 $^\circ\mathrm{C}$, but the northern British Columbia population survives best where mean annual temperatures are ~ 1 $^\circ\mathrm{C}$ and the Idaho population best at ~ 4 $^\circ\mathrm{C}$ [@Rehfeldt1999a]. 
Local adaptation in lodgepole pine can be observed even at relatively small spatial scales when topographic variability is high: in a reciprocal transplant experiment, growth declines were observed when moving high elevation populations just 100m in elevation [@Rehfeldt1983]. [Summarize/cite adaptree work]



Pollen is an important vector for identifying gene flow in lodgepole pine because outcrossing is common, pollen dispersal is extensive, and seed dispersal is relatively limited [@Ennos1994]. There is evidence for spatially varying levels of gene flow in the species as populations from areas with higher regional climate heterogeneity have higher genetic variance [@Yeaman2006]. Pollination phenology could control this. 

Pollination phenology determines which populations can exchange genes, but predicting the timing of pollen shed and cone receptivity has not been done in lodgepole pine.  Pollination phenology examples are uncommon. [Talk about Sarvas investigations for mechanistic background, why using temperature, etc.]
Simple heat accumulation thresholds (*Pinus taeda*) [@Boyer1978] or elevation (*Pinus flexilis*) [@Schuster1989] were used previously to explain or predict pollen shed in limited spacial and temporal contexts.
@Owens2006 reports that lodgepole pine pollen shed and cone receptivity occur when degree days reach about 500 at a threshold of 5 $^\circ\mathrm{C}$, but this is the only report of pollination phenology modeling for lodgepole pine and limited details are provided. 
Models of lodgepole pine vegetative phenology, on the other hand, are better represented in the literature (*e.g.* @Chuine2001), and pollen shed and cone receptivity are not expected to have additional or more complex triggers or model forms than budburst [@Chuine2013a].

Predicting pollination phenology will also have practical benefits. Seed orchard managers in British Columbia are particularly concerned about protandry, when all pollen in an area is shed before cones become receptive (*personal communication, Chris Walsh, Former Seed Orchard Manager, Kalamalka Seed Orchards, February 13, 2013*). 
Protandry occurs in particularly hot and dry years [@Owens2005]. If this pattern holds, protandry could become more common in natural populations, leaving some populations pollen limited and likely hampering local adaption. [Outcrossing! Inbreeding!]

This paper relies on 15 year pollination phenology data set collected in British Columbia lodgepole pine seed orchards. Seed orchards produce seed for reforestation. While not set up as common gardens, several provenances are typically represented at each  site allowing testing for provenance effects and genetic x environmental interaction. and genotypes usually appear multiple times within a site and sometimes at multiple sites.

I will use pollination phenology and temperature data to fit a mechanistic model predicting pollen shed and cone receptivity across the entire range of *Pinus contorta* var. *latifolia* and consider how the date and length of pollination phenology periods vary normally and under several climate change scenarios. 
Specifically, I will answer 1) What is the relationship between temperature and pollen shed and temperature and cone receptivity timing and length? 2) Does provenance affect that relationship? 3) How many days will pollination phenology shift under the next 30, 60, and 90 years of climate change 4) Will protandry become more common?

# Methods

My aim was to model pollination phenology in lodgepole pine and calculate synchrony across the distribution. To determine the timing of pollen shed and cone receptivity, I modeled the forcing requirements for pollination phenology in lodgepole pine and investigated differences in forcing requirements between males and females and among provenances. 

## Study species

Lodgepole pine is a wind-pollinated conifer with an extensive range and well documented local adaptation. While lodgepole pine has four subspecies, this work concerns only *Pinus contorta* subsp. *latifolia*. Pollen and seed cone buds differentiate in late summer and early fall, then go dormant. As temperatures warm the following year, buds resume development and strobili "flower"; receptive female strobili exude pollination drops between bracts that capture pollen shed from mature male strobili.

![Rangemap of lodgepole pine. After @Little1971 \label{range}.](/home/sus/Documents/research_phd/maps/SpeciesDistribution/distmap_pincon.png)

### Data

#### Phenology Data

This project takes advantage of an existing lodgepole pine pollination phenology dataset collected over a decade and a half by government and industry workers in seed orchards. Seed orchards in British Columbia produce large amounts of tree seed for reforestation from parent trees sourced from provenances around the province. In the 90s, it became apparent that seed yields at seed orchards in the southern interior were much lower than in more northern seed orchards. To plan for future seed production and orchard establishment and management, seed orchard managers monitored pollination phenology and seed production to understand why seed yields at north Okanagan orchards were lower than at the Prince George Tree Improvement Station orchards. Pollination phenology data was collected at the Prince George Tree Improvement Station in British Columbia beginning in 1997 and collection at many other BC tree orchard sites began in 2006 under the Forest Genetics Council's Operational Tree Improvement Program 0722 [@Webber2007]. 


##### Sites
Trees selected from across the British Columbia portion of the lodgepole pine range are grown in seed orchards as part of tree breeding and seed production programs. Between 1997 and 2011, flowering phenology of lodgepole pine was recorded at 7 seed orchard sites in the interior of British Columbia. I contacted Seed Orchard Managers and other forestry professionals across British Columbia in 2012 and received pollination phenology data from C. Walsh, previously at Kalamalka Seed Orchards (now retired), R. Wagner at the Prince George Tree Improvement Station, and J.E. Webber previously at the Glyn Road Research Station (now retired). 4 of the sites are clustered near to one another around Vernon, BC, but sites span about 5 $^\circ$ of latitude and are at elevations from 466 to 638 m.

![Map of seed orchard locations. Seed orchard locations are in red. Weather data gridpoints are in blue. Boxed area in map on left is shown in greater detail on the right. ](/home/sus/Documents/research_phd/maps/SiteMaps/sitemapwithPCIC.png)


##### Provenances
Trees grown at the seed orchard sites were sourced from 6 biogeoclimate regions known as Seed Planning Units (SPUs). Trees with the same SPU provenance are grown together in an orchard at a given site. Genotypes (labelled with a Clone number in the data) in the orchards are represented by multiple ramets. 

I obtained pollination phenology records from 17 of the 26 lodgepole pine seed orchards in British Columbia. Orchards include the offspring of trees from 6 of the 7 BC seed planning zones (SPZs) (Figure \ref{SPZ}) grown at at 7 sites across BC. SPZs are biogeoclimatic and political units used for seed planting purposes by British Columbia. SPZs are divided into elevation bands called Seed Planning Units (SPUs), which form this project's provenances. 

Thirteen out of 17 orchards in my data set are first generation orchards and should faithfully represent their provenances. These first generation orchards represent 6 provenances at 5 sites. Second generation orchards have been selectively crossed and this may skew the mean or variance of phenology for a provenance if pollination phenology varies by provenance.

Most provenances are represented at 2 to 3 sites and have at least three years of data at a given site spanning 1997-2012 (Figure \ref{contingency}). The Prince George Tree Improvement Station (PGTIS) provides a continuous 15-year record of its three orchards' phenology.

![Contingency table of years of data for Seed Planning Units (rows) and Seed Orchard Sites (columns). Seed Planning Zones, used as provenances in this project, are usually represented at multiple years and multiple sites. There is particularly good representation at PGTIS. \label{contingency}](/home/sus/Documents/research_phd/phd_proposal/figure/contingencytable.png)


![Map of Seed Planning Units (SPUs). Seed planning units are biogeoclimatic and political units used for seed planting purposes by British Columbia. Seed planning units form this project's provenances. High, Low, and Mid refer to elevational bands. Data is also available for East Kootenay Low, but will likely not be included in any analysis as it includes only one year at one site. \label{SPZ}](/home/sus/Documents/research_phd/maps/SPUmaps/SPUmap_subset.png)

[table with Site Columns and SPU rows with years of data as values]
 [table of number of trees/clones in a given year for a given site/spu combo]

##### Phenology scoring protocol
Protocol C in [@Woods1996] was used as the basis for collecting pollen shed and cone receptivity data, though operational constraints led to some modifications. Workers monitored seed orchards for the beginning of pollen shed and cone receptivity. ~15 clones, usually represented by 2 trees each, were selected for specific observations. When the active period seemed to be starting, workers went into the orchard every few days to make observations on the selected trees.

Stages of pollen and seed cone development are described by [Owens & Molder 1984 and updated in Owens2006] and were used as a general guide for determining the phenological state of pollen and seed cones. Pollen cones are flowering when tapping causes pollen to be released and seed cones are flowering when there are gaps between the bract-scale complexes. Pollination drops are also produced during flowering, though they recede midday if pollen is not present [@Owens2006]. 

"Flowering" states were recorded for both pollen shed and cone receptivity at the level of each tree. Protocol C recommends marking the dates when 20% of the cones on a tree have begun flowering and when 80% of the cones on a tree have finished flowering. Operationally, there was some subjectivity and tree-level states for each cone type should be interpreted as "starting flowering" and "finished flowering." There is some subjectivity here. 

[DESCRIBE SURVEY PERIODS, MAYBE MAKE A TABLE OR GRAPH OF OBSERVATION DATES?]

Observations were not made every day and survey periods varied in length. At Prince George, not all trees have complete phenological records, *e.g* if a tree is not flowering on the first day of observation, the start date is unknown. 


##### Harmonization and cleaning

Describe data transcription and cleaning.

There were some differences in how data was recorded at the Prince George Tree Improvement Station versus the other sites. At Prince George, trees were marked as flowering or not flowering on each day of observation. At other sites, only the first day observed flowering and the first day observed finished flowering were recorded. I inferred that trees were not yet flowering on observation days prior to their first recorded flowering date. I cleaned and harmonized the data for analysis in a single model using R scripts provided so that, for pollen cones and seed cones, stage 1 = not yet flowering, stage 2 = flowering, and stage 3 finished flowering. 

There are three phenological stages of interest each for a tree's male and female cones

- 1. The cones have not yet flowered
- 2. The cones are flowering
- 3. The cones have finished flowering

Phenophases in the field were recorded using different symbol sets and resolutions. I assigned each symbol to one of the phenophases above. Trees that did not produce cones are assigned phenological stage 0.


```{r phenophase_derivation, echo=FALSE}
no_flowers <- '0'
#before_flowering <- c('1', '2.5', '-') #stage 1
before_flowering <- c("1, 2.5, -")
#flowering <- c('3', '3.5', '4', '4.5', '5', 'pollenshed20', 'receptive20') #stage 2
flowering <- c("3, 3.5, 4, 4.5, 5, pollenshed20, receptive20")
#after_flowering <- c('-', 'receptive80', 'pollenshed80') #stage 3
after_flowering <- c("-, receptive80, pollenshed80")
derived_phenophase <- c(0:3)
male_desc <- c("none produced", "not yet shedding", "shedding", "finished shedding")
female_desc <- c("none produced", "not yet receptive", "receptive", "no longer receptive")
recorded_as <- c(no_flowers, before_flowering, flowering, af=after_flowering)

phenophase_legend <- data.frame(Phenophase = derived_phenophase, Symbols = recorded_as, Male.Cones = male_desc, Female.Cones = female_desc)
kable(phenophase_legend, padding = 0)
```

#### Weather data

Daily weather data at seed orchard sites was extracted from PNWNAmet, a daily gridded meteorological dataset at 1/16 $^\circ$ over northwest North America [@pacificclimateimpactsconsortiumPNWNAmet194520122014]. The closest point in the PNWNAmet was used for each station. Mean daily temperature was calculated from the minimum and maximum daily temperatures.

![Map of Sites with nearest climate gridpoints](/home/sus/Documents/research_phd/maps/SiteMaps/siteswithclimategrid.png)

#### Forcing units

The relative effect of mean daily temperature $t$ on the rate of forcing was calculated with

$$R(t) = \frac{28.4}{1+ e^{-0.185*t-18.4}}$$
which describes the relationship between temperature and development rate. This equation for forcing units is based on experimental work from Risto Sarvas with in temperate forest tree species [@Sarvas1972, @hanninenModellingBudDormancy1990]. @Chuine1999 found this calculation of forcing units superior to degree day calculations.  
Forcing Units on day $d$ ($f_d$) are the sum of the relative temperature effect from January 1 (ordinal date $1$) to day $d$.

$$f(d) = \sum_{i=1}^d R_d(x)$$

The rate of forcing was experimentally determined by Sarvas [@Sarvas1972] and verified to perform better than growing degree day models by Chuine [@Chuine1999]


## Phenology Modeling 

I modeled the derived phenological states with a Bayesian multilevel ordered logistic model fit in Stan with the no-u-turn sampler [@standevelopmentteamRStanInterfaceStan2018]. A cumulative link function (in this case logistic) accounts for the ordering of phenological states and relates phenological states to a linear model. This type of model makes no assumption about the distance between phenological states and estimates intercepts (typically called "cutpoints" in ordered regression models) that separate each state. 

The model was fit separately to data for male strobili and female strobili.

The likelihood of being in state $s \in \{1,2,3\}$ is


$$\mathrm{Pr}(S=s)=\text{OrderedLogistic}(s~|~\eta,\kappa) = \left\{ \begin{array}{ll} 1 -
\text{logistic}(\eta - \kappa_1)  &  \text{if } s = 1 \\[4pt]
\text{logistic}(\eta - \kappa_1) - \text{logistic}(\eta - \kappa_2)  &
\text{if } s=2  \\[4pt] \text{logistic}(\eta -
\kappa_2) - 0  &  \text{if } s = 3 \end{array} \right.$$

where the cutpoints $\kappa_s < \kappa_{s+1}$ and $\eta$ is a linear model relating forcing units to phenological state. $\beta$ parameters in $\eta$

Slope parameters ($\beta_{foo}$) in $\eta$

Cumulative probability curves can be plotted for each transition

probability transitioned = pOrderedLogistic(kappa_{i}, \eta)



$$\begin{array}{rlr}
S_i & \sim \mathrm{OrderedLogistic}(\eta,\kappa) & \text{probability of data}\\
\eta_i & = (\beta + \beta_{site} +\beta_{prov} + \beta_{clone} + \beta_{year}) f_i  & \text{linear model}\\
\kappa_k & \sim \mathrm{gamma}(7.5,1) & \text{fixed priors}\\
\beta & \sim \mathrm{exponential}(2) & \text{}\\
\beta_{site} & \sim \mathrm{normal}(0,\sigma_{site}) & \text{adaptive priors}\\
\beta_{prov} & \sim \mathrm{normal}(0,\sigma_{prov}) & \text{}\\
\beta_{year} & \sim \mathrm{normal}(0, \sigma_{year}) \\
\beta_{clone} & \sim \mathrm{normal}(0, \sigma_{clone}) \\
\sigma_{site} & \sim \mathrm{exponential}(3) & \text{hyperpriors}\\
\sigma_{prov} & \sim \mathrm{exponential}(3) \\
\sigma_{year} & \sim \mathrm{exponential}(3) \\
\sigma_{clone} & \sim \mathrm{exponential}(3) \\
\end{array}$$

I tried to use weakly informative priors, but simulations or more reading are required to decide if these are actually weakly informative or if they are too diffuse. Plotting the prior distributions with the parameter values would also probably help. 

Another way to think about the probabilities in this model:

$$\begin{array}{rll}
S_i&\sim \mathrm{Categorical}(\bf{p}) &\text{probability of data} \\
p_1 & = q_1 &\text{probabilities of each value of } k\\
p_2 & = q_2 - q_1 \\
p_3 & = 1-q_3 \\
logit(q_k) &= \kappa_k - \eta_i &\text{cumulative logit link} \\
\eta_i&= (\beta_{site} +\beta_{prov} + \beta_{clone} + \beta_{year}) f_i  & \text{linear model} &\text{linear model}\\
\\
\end{array}$$


To quantify accuracy of the model, I will calculate the difference in variance within and between populations. Only phenological differences larger than the within population variance will be considered. The maps and parameters of these models can be compared to answer the following questions.

#### Flowering period timing and length

Forcing units required to induce cone receptivity and pollen shed.

I considered the beginning of the phenological period as the probability at which a tree was 20% likely to have passed out of stage 1 and the end of the phenological period as the probability at which a tree was 80% likely to have passed out of stage 2. This is equivalent to 20% of the trees in the population having reached stage 2 and 80% having reached stage 3.

The probability that a tree has passed out of a given stage $k$ is

$$Pr(s_i > k) = \mathrm{logistic}(\vec{\beta}f_i-\kappa_k)$$
The accumulated forcing units at which flowering is considered to start $f_{start}$ is 

$$ \mathrm{Pr}(s_i>1) = 0.2 = \mathrm{logistic}(\mathbf{\vec\beta f_{start}}-\kappa_1)\\
f_{start} = \frac{\log(\frac{.2}{1-.2}) + \kappa_1}{\vec\beta}
$$

and, similarly $f_end$ is
$$ 

f_{end} = \frac{\log(\frac{.8}{1-.8}) + \kappa_1}{\vec\beta}
$$

I calculated $f_{start}$ and $f_{end}$ for all clone site provenance year groupings in the dataset for all draws. The range of forcing units that stage 2 occurs over, *i.e.* the active phenological period, is 

$$ range = f_{start} - f_{end}$$

#### Dates

$f_{start}$ and $f_{end}$ were matched to corresponding dates. Because $\beta_{year}$ is included as an effect, $f_{start}$ and $f_{end}$ are specific to the year the data was collected.

#### Differences between provenances

The point at which a tree is 50% likely to have transitioned from one phenophase to another can be calculated by dividing the cutpoint for the transition by the slope.

The halfway point between any 2 consecutive phenological states is 

$$\mathrm{Pr}(s>i) = 0.5 \\
f_{half_i} = \frac{\kappa_i}{\vec\beta}$$

$$\begin{array}{ll}
\bf{H}_1 &= \kappa_1/(\beta_{site} +\beta_{prov} + \beta_{clone} + \beta_{year})\\
\bf{H}_2 &= \kappa_2/(\beta_{site} +\beta_{prov} + \beta_{clone} + \beta_{year})\\
\end{array}$$

Were calculated according to [@vandermijnsbruggeVariationBudBurst2015] - "difference in days in which half the plants has reached the same score level"

$$\mathrm{H50}_{prov_i} - \mathrm{H50}_{prov_j} = \beta_{prov_j} - \beta_{prov_2}/\beta$$

#### Assumptions 
Chilling requirements are met and chilling and forcing periods do not overlap. Forcing is a function of temperature only, not photoperiod or chilling. Both phases occur at the same rate.

# Results

1) How strong are the genetic vs. environmental effects on pollination phenology?

To answer this question I will compare the parameters of models fit by provenance. If different provenances have significantly different model parameters - that is, have different heat sum requirements for pollen shed and cone receptivity by provenance, then the rest of my project will be limited to the provenances I have data from. If not, I can use the same models across the entire range when predicting phenological events.

The budburst and spring pollination phenology of temperate tree species is determined by temperature, and there may be some regional variation in the temperatures required for pollen shed and cone receptivity;
in lodgepole pine, the threshold for shoot elongation was 5.1 $^\circ\mathrm{C}$ for coastal and interior provenances, but 6.5 $^\circ\mathrm{C}$ for northern provenances [@Chuine2001].

However, seedling spring vegetative phenology data from four growth chamber temperature and moisture treatments in the AdapTree project suggests that budburst shows substantial clinal variation (> 10% of phenotypic variance explained) only in the coldest treatment tested (MAT of 1 $^\circ\mathrm{C}$), and much colder than the seed orchard locations (Figure \ref{siteprovclimate}, Figure \ref{Liepe_Pheno_Corr}, @Liepe2014 (submitted)). Analysis of phenotypic data from an outdoor common garden in Vancouver (*personal commmunication, Ian Maclachlan, AdapTree Graduate Student, January, 1 2015*) also shows that very little variation exists among provenances for spring phenology, regardless of whether seedlings originate from wild-stand or selectively bred seed orchard seedlots.

![Variance in budbreak and budset for lodgepole pine explained by provenance climate. Seedlings from 281 locations across lodgepole's BC range were grown in growth chambers under four treatments: approximated seasonal and daily variation in temperature for geographic locations with a MAT of 1, 6, and 11 $^\circ\mathrm{C}$, with the warmest treatment having a dry and wet version. Pearson's correlation coefficient between phenotypic traits in lodgepole pine and provenance climates are presented. The vertical line represents the critical $r^2$ value after an adjustment for multiple inferences. From @Liepe2014 (submitted). \label{Liepe_Pheno_Corr}](/home/sus/Documents/research_phd/phd_proposal/figure/Liepe_phen_corr.png)

2) How does faster spring warm-up like we expect under climate change affect within population mating success and frequency of outcrossing?

I expect that faster spring warm-up will condense as well as advance growth initiation dates and also shorten pollination phenological periods by speeding development prior to and during the phenological period. This should further synchronize populations in similar climates and act as a barrier to breeding with populations in more different climates. On the other hand, it could favor outcrossing over selfing by causing protandry - pollen shed in advance of cone receptivity. Based on anecdotal reports from seed orchards managers, I expect protandry (and thus outcrossing) to increase under climate change.

I will examine the variability of the start date across the range ($t_1$) to see if it shrinks in warmer years and as the climate changes. I will also calculate overlap between within population cone receptivity and pollen shed under current conditions and with climate warming and see if the heat sum requirements for cone receptivity and pollen shed are different.


## Model summary

```{r model data}
ffit.stan <- readRDS("FEMALE_slopes_scaled.rds")
mfit.stan <- readRDS("MALE_slopes_scaled.rds")

fsum <- rstan::summary(ffit.stan)$summary
fsum <- as.data.frame(fsum)
fsum$par <- rownames(fsum)
fpost <- as.data.frame(ffit.stan)
fpost_re <- extract.samples(ffit.stan)
fparam_names <- colnames(fpost)

flp <- log_posterior(ffit.stan)
fnp <- nuts_params(ffit.stan) #nuts params

msum <- rstan::summary(mfit.stan)$summary
msum <- as.data.frame(msum)
msum$par <- rownames(msum)
mpost <- as.data.frame(mfit.stan)
mpost_re <- extract.samples(mfit.stan)
mparam_names <- colnames(mpost)

mlp <- log_posterior(mfit.stan)
mnp <- nuts_params(mfit.stan) #nuts params

#mf
fpost$sex <- 0
mpost$sex <- 1


post <- full_join(mpost, fpost) %>%
    select(-`b_clone[260]`)
```

### Parameter estimates

Clones not included

*Female*
```{r param female table}
kable(
fsum[str_detect(fsum$par, "b_clone", negate=TRUE) , ], digits=3)
```

*Male*
```{r param male table}
kable(
msum[str_detect(msum$par, "b_clone", negate=TRUE) , ], digits=3)
```

```{r compare plot function}

compare_fm <- function(femplot, mplot, nrow = 2, ...) {
    bayesplot_grid(
        femplot, mplot,
        grid_args = list(nrow = nrow),
        subtitles = c("Female",
                      "Male"),
        ...
    )
}

compare_fm_wide <- function(femplot, mplot, ncol = 2, ...) {
    bayesplot_grid(
        femplot, mplot,
        grid_args = list(ncol = ncol),
        subtitles = c("Female",
                      "Male"),
        ...
    )
}
```


```{r compare site and prov intervals}
ggplot(post, aes(x=beta, fill=as.factor(sex))) +
    geom_density(alpha=0.5) + 
    ggtitle("male and female speed of transition estimates")

fint_beta <- mcmc_areas(fpost, regex_pars = "beta") + ggtitle("beta")
mint_beta <- mcmc_areas(mpost, regex_pars = "beta")

compare_fm(fint_beta, mint_beta, xlim=c(0.05, 0.10))

fkap <- mcmc_areas(fpost, regex_pars = "kappa")
mkap <- mcmc_areas(mpost, regex_pars = "kappa")

compare_fm_wide(fkap, mkap, xlim=c(18, 29))

color_scheme_set("blue")
fint_site <- mcmc_intervals(fpost, regex_pars = c("site", "prov"))
mint_site <- mcmc_intervals(mpost, regex_pars = c("site", "prov"))

compare_fm_wide(fint_site, mint_site) 

fa_sigma <- mcmc_areas(fpost, regex_pars= "sigma") + ggtitle("variance")
ma_sigma <- mcmc_areas(mpost, regex_pars= "sigma")

compare_fm_wide(fa_sigma, ma_sigma)

fa_y <- mcmc_areas(fpost, regex_pars = "year") + ggtitle("year")
ma_y <- mcmc_areas(mpost, regex_pars = "year")

compare_fm_wide(fa_y, ma_y)

```

```{r compare clones}
fint_c <- mcmc_intervals(fpost, regex_pars = c("clone"), point_est="none") + ggtitle("Clone effects")
mint_c <- mcmc_intervals(mpost, regex_pars = c("clone"), point_est="none")

compare_fm_wide(fint_c, mint_c)
```

### Sex diff

```{r half transitions - no effects}
fpost$f1 <- fpost$`kappa[1]`/fpost$beta
fpost$f2 <- fpost$`kappa[2]`/fpost$beta
mpost$f1 <- mpost$`kappa[1]`/mpost$beta
mpost$f2 <- mpost$`kappa[2]`/mpost$beta

ff <- mcmc_areas(fpost, pars = c("f1", "f2")) + ggtitle("half transitions")
mf <- mcmc_areas(mpost, pars = c("f1", "f2")) + ggtitle("half transitions")

compare_fm(ff, mf)
```


# Discussion

### Limitations of the dataset

Benefits of this dataset include the large number of trees, long time series, multiple provenances grown at multiple sites giving a semi-common garden design, and the inclusion of clones. Limitations include interval and end censoring, especially at Prince George, irregular scoring systems, subjective scoring, non-random clone selection, and selective breeding.

### Grafting bias?

### Problems from breeding
There are two types of orchards: first generation and advanced. 
Each orchard contains trees that are the descendants of seeds and scions collected from mother trees in one particular provenance.
First generation orchards have not undergone selective breeding but may be subject to selection through the process of choosing mother trees (called "plus" trees by tree breeders), testing and selection of mother tree offspring, or culling of unfavorable trees in the orchard.
First generation orchard trees are clones of mother trees and their offspring grafted onto rootstock.
There are three types of first generation orchards subject to different levels of selection: 1.0, 1.5, and 1.75 generation orchards.
All orchards are subject to selection based on mother tree selection.
In 1.5 generation orchards, superior offspring of mother trees are selected for the orchard or poor trees are culled from the orchard. 
This selection may be strong; more than 50% of offspring can be rejected in this process due to poor growth form [@Ukrainetz2011].
In 1.75 generation orchards, data from 10 year tests of mother tree offspring are used to select 40 of the best genotypes for a given provenance.
Offspring from controlled crosses between trees in first generation orchards are tested in field trials and the best trees are then cloned and grafted onto root stock in advanced generation orchards. 

```{r calculate orchard generations}
orchards_in_data <- read.csv("~/Documents/research_phd/data/PhenologyAndPollenCounts/data_formatted_and_derived/derived_phenophase.csv", header=TRUE, stringsAsFactors = FALSE) %>% 
    select(Orchard, Year, ) %>%
    group_by(Orchard) %>%
    dplyr::summarise(Years = n_distinct(Year))
orchard_gen <- read.csv("~/Documents/research_phd/data/OrchardInfo/OrchardGen.csv", header=TRUE, stringsAsFactors = FALSE)

orchard_meta <- dplyr::left_join(orchards_in_data, orchard_gen) %>%
    unique()

knitr::kable(orchard_meta)


```

### selection only from a portion of the range
Provenances and sites included in my data exclude the coldest and wettest parts of the range. Figure \ref{siteprovclimate} shows the 1961-1990 climate normal mean annual temperature (MAT) and mean annual precipitation (MAP) for data from all lodgepole pine provenances in BC, provenances included in my data set, and sites where provenances were grown. Orchard sites are generally much warmer and drier than many locations where lodgepole pine grow. I may have difficulty extrapolating into the coolest and wettest parts of the lodgepole pine range, depending on actual yearly conditions at sites for which I have data. However, this may be advantageous when it comes to predicting phenology under climate change.

![Provenance (SPU) climates of data included in this proposal, provenances not included in this proposal, and sites where provenances were grown. MAT is mean annual temperature and MAP is mean annual precipitation. \label{siteprovclimate}](/home/sus/Documents/research_phd/phd_proposal/figure/climate.png)

## no chilling
Previous models for lodgepole pine have fitted spring growth phenology models without considering chilling [@Chuine2001] and, in general, budburst models for boreal tree species have not required chilling to give accurate predictions [@Linkosalo2000].
For lodgepole pine growing in natural environments, chilling is always met and should continue to be met under the next century of climate change; 
in the AdapTree project, lodgepole pine seedlings grown for three to four weeks at 4 $^\circ\mathrm{C}$ met their chilling requirements.
Thus, I expect to be able to disregard the state of chilling and fit only Equations \ref{forcing} and \ref{simp_force_amt}).
Once the model is parameterized I will be able to calculate the timing of pollen shed and cone receptivity across the lodgepole pine species range using location specific climate data from seed orchards and ClimateWNA [@Wang2012]. 
I will validate the model by comparing predictions to phenological measurements from the National Phenology Network.
